name: CI/CD Pipeline

# Trigger on push to main branch
on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

# Environment variables used across jobs
env:
  DOCKER_IMAGE_NAME: projects
  DOCKER_IMAGE_TAG: studybud_v1
  CONTAINER_NAME: studybud_app
  APP_PORT: 9000

jobs:
  # STAGE 1: Checkout Code
  checkout-and-build:
    name: Build and Push Docker Image
    runs-on: ubuntu-latest
    
    steps:
      # Checkout themain branch
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          ref: main
      
      # Make build script executable
      - name: Make Build Script Executable
        run: chmod +x buildDockerScript.sh
      
      # Set up Docker Buildx (for better caching)
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      # Login to Docker Hub
      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}
      
      # Build and push using the existing script
      - name: Build and Push Docker Image
        env:
          DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
          DOCKER_PASSWORD: ${{ secrets.DOCKER_PASSWORD }}
        run: |
          echo "Building the image and pushing...."
          ./buildDockerScript.sh
      
      - name: Build Complete
        run: echo "✅ Docker image built and pushed successfully!"

  # STAGE 2: Deploy to EC2
  deploy-to-ec2:
    name: Deploy to EC2 Instance
    needs: checkout-and-build
    runs-on: ubuntu-latest
    
    steps:
      # Copy deploy.sh to EC2
      - name: Copy deploy.sh to EC2
        uses: appleboy/scp-action@v0.1.4
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_KEY }}
          source: "deploy.sh"           
          target: "/home/ubuntu/deploy.sh"

      # Deploy to EC2 using SSH
      - name: Deploy to EC2 via SSH
        uses: appleboy/ssh-action@v1.0.0
        env:
          DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
          DOCKER_PASSWORD: ${{ secrets.DOCKER_PASSWORD }}
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_KEY }}
          envs: DOCKER_USERNAME,DOCKER_PASSWORD
          script: |
            set -e
            echo "Connected to EC2"
            
            # Install Docker if not installed
            if ! command -v docker &> /dev/null; then
                echo "Installing Docker..."
                sudo apt update -y
                sudo apt install -y docker.io
                sudo systemctl start docker
                sudo systemctl enable docker
                sudo usermod -aG docker ubuntu
                echo "Docker installed successfully"
            else
                echo "Docker is already installed"
            fi

            # Prepare persistent folder for SQLite
            echo "Creating SQLite persistent folder..."
            mkdir -p /home/ubuntu/sqlite
            
            
            # Run deploy script
            chmod +x ~/deploy.sh
            echo "Running deployment script..."
            bash ~/deploy.sh
            
            echo "✅ Deployment completed successfully!" 